require 'rake'
require 'rspec/core/rake_task'
require 'open-uri'

def wait_until times=30
  until (times-=1) == 0
    sleep 1
    return if yield
  end
  raise 'timeout waiting'
end

task :start_mockserver => :stop_mockserver do
  puts "Starting mockserver"
  `thin -p 7000 -l thin.log -D -V -d -R lib/config.ru start`
  wait_until do
    begin
      open('http://localhost:7000/mockserver/clear')
    rescue
    end
  end
end

task :stop_mockserver do |task|
  puts "Stoping mockserver"
  `thin stop`
  wait_until do
    FileList.new('tmp/pids/*.pid').size == 0
  end
  FileUtils.rm_rf('tmp')
  task.reenable
end

desc "Run all examples"
RSpec::Core::RakeTask.new('specs') do |t|
  t.pattern = 'spec/**/*_spec.rb'
end


task :default => [:start_mockserver, :specs, :stop_mockserver]