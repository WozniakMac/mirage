#!/usr/bin/env ruby
require 'rubygems'
require 'mirage/client'
require 'open-uri'
require 'optparse'
require 'mechanize'
$LOAD_PATH.unshift(File.dirname(__FILE__))
MOCKSERVER_URL = "http://localhost:7001"

def wait_until time=30
  start_time = Time.now
  until Time.now >= start_time + time
    puts "waiting"
    sleep 0.1
    return if yield
  end
  raise 'timeout waiting'
end


mirage = Mirage::Client.new
if ARGV.include?('start')
  if mirage.running?
    puts "Mirage already running"
    exit 1
  end


  puts "Starting the Mirage"
  `thin -p 7001 -l thin.log -D -V -d -R #{File.dirname(__FILE__)}/../lib/config.ru start`

  wait_until do
    mirage.running?
  end


elsif ARGV.include?('stop')
  puts "Stoping Mirage"
  `thin stop`
  wait_until 45 do
    !mirage.running?
  end

else
  puts "You must choose to: Start or Stop the mirage"
  exit 1

end
