require 'rubygems'
require 'bundler/setup'
Bundler.setup(:test)
require 'rake'
require 'open-uri'
require 'cucumber'
require 'cucumber/rake/task'
require 'mechanize'
MOCKSERVER_URL = "http://localhost:7000"

module Web
  def get url, params={}
    if params[:body]
      response = Net::HTTP.start("localhost", 7001) do |http|
        request = Net::HTTP::Get.new(url)
        request.body=params[:body]
        http.request(request)
      end

      def response.code
        @code.to_i
      end

    else
      response = using_mechanize do |browser|
        browser.get("#{MOCKSERVER_URL}#{url}", params)
      end

    end

    response
  end

  def post url, params
    using_mechanize do |browser|
      browser.post("#{MOCKSERVER_URL}#{url}", params)
    end
  end

  private
  def using_mechanize
    begin
      browser = Mechanize.new
      browser.keep_alive = false
      response = yield browser

      def response.code
        @code.to_i
      end
    rescue Exception => e
      response = e

      def response.code
        self.response_code.to_i
      end
    end
    response
  end

end


include Web

def wait_until time=30
  start_time = Time.now
  until Time.now >= start_time + time
    sleep 0.1
    return if yield
  end
  raise 'timeout waiting'
end

def run_command command
  system "export RUBYOPT='' && #{command}"
end

task :gem => :clean do
  run_command 'gem build mirage.gemspec'
end

task :install => :gem do
  run_command "gem install mirage"
end

Cucumber::Rake::Task.new(:features) do |t|
  t.cucumber_opts = "mode=regression features --format pretty"
end

task :start_mirage => :stop_mirage do
  run_command "mirage start"
  task.reenable
end

task :stop_mirage do |task|
  puts "stoping mirage"
  run_command "mirage stop"
  task.reenable
end


task :clean do |task|

  if run_command "gem list -i mirage"
    puts "cleaning"
    run_command "gem uninstall -x mirage"
  end
  Dir['*.gem'].each{|gem| FileUtils.rm_f(gem)}
  task.reenable
end


task :default => [:install, :start_mirage, :features, :stop_mirage, :clean]